<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Monster Battle</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root {
            --p-color: #FF9AA2;
            --e-color: #85E3FF;
            --bg-color: #FFF5F5;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: #444;
            text-align: center;
            margin: 0; padding: 0;
            overflow-x: hidden;
        }
        h1 { margin: 10px 0; font-size: 1.2rem; color: #FF6F61; }
        
        #game-container { max-width: 600px; margin: 0 auto; padding: 10px; }
        
        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ (QuaggaJSç”¨èª¿æ•´) */
        #scan-ui { display: none; }
        #camera-area { 
            position: relative; margin: 10px auto; width: 100%; max-width: 320px; height: 240px; 
            background: #000; border-radius: 10px; overflow: hidden; border: 4px solid #333;
        }
        /* QuaggaãŒvideoã‚¿ã‚°ã‚’ã“ã“ã«æŒ¿å…¥ã—ã¾ã™ */
        #camera-area video { width: 100%; height: 100%; object-fit: cover; }
        /* èª­ã¿å–ã‚Šã‚¬ã‚¤ãƒ‰ç·š */
        .scan-guide {
            position: absolute; top: 50%; left: 10%; right: 10%; height: 2px; background: red; 
            z-index: 10; box-shadow: 0 0 4px red; opacity: 0.7;
        }

        #scan-instruction { margin-bottom: 10px; font-weight: bold; }

        /* ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ï¼ˆå‰å›ã¨åŒã˜ï¼‰ */
        #battle-ui { display: none; }
        .battle-field { display: flex; justify-content: space-between; align-items: flex-end; padding: 20px; height: 200px; background: #fff; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px; position: relative; }
        
        .monster-card { width: 45%; text-align: center; transition: all 0.3s; }
        .monster-emoji { font-size: 4rem; display: block; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
        .monster-name { font-weight: bold; font-size: 0.9rem; margin-top: 5px; display: block; }
        .hp-bar-container { width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .hp-bar { height: 100%; width: 100%; transition: width 0.5s; }
        
        .player .hp-bar { background: var(--p-color); }
        .player .monster-emoji { transform: scaleX(-1); }
        .enemy .hp-bar { background: var(--e-color); }
        
        #log-box { 
            height: 150px; overflow-y: scroll; 
            background: #fff; border: 2px solid #eee; 
            border-radius: 10px; padding: 10px; text-align: left; font-size: 0.9rem; 
            margin-bottom: 10px;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        
        .bench { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .bench-icon { font-size: 1.5rem; opacity: 0.5; }
        .bench-icon.alive { opacity: 1; }
        .bench-icon.dead { opacity: 0.2; filter: grayscale(100%); }

        button {
            background: #FF6F61; color: white; border: none; padding: 10px 20px;
            font-size: 1rem; border-radius: 20px; cursor: pointer; margin-top: 10px;
        }
        button:disabled { background: #ccc; }

        .damage-anim { animation: shake 0.5s; }
        .attack-anim { animation: lunge 0.3s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        @keyframes lunge { 0% { transform: translateX(0); } 50% { transform: translateX(20px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

<div id="game-container">
    <h1>Barcode Monster Battle</h1>

    <div id="scan-ui">
        <div id="scan-instruction">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­... (<span id="scan-count">0</span>/3)</div>
        <div id="camera-area">
            <div class="scan-guide"></div>
        </div>
        <p style="font-size:0.8rem; color:#888;">
            å•†å“ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆJANã‚³ãƒ¼ãƒ‰ï¼‰ã‚’<br>
            èµ¤ã„ç·šã«åˆã‚ã›ã¦ãã ã•ã„ã€‚<br>
            <span style="color:red;">â€»æ˜ã‚‹ã„å ´æ‰€ã§ã€ã‚«ãƒ¡ãƒ©ã‚’è¿‘ã¥ã‘ã™ããšã«ï¼</span>
        </p>
    </div>

    <div id="battle-ui">
        <div class="bench" id="enemy-bench"></div>
        <div class="battle-field">
            <div class="monster-card player" id="p-card">
                <span class="monster-name" id="p-name">Monster</span>
                <div class="hp-bar-container"><div class="hp-bar" id="p-hp-bar"></div></div>
                <span class="monster-emoji" id="p-emoji">ğŸ£</span>
            </div>
            <div class="monster-card enemy" id="e-card">
                <span class="monster-name" id="e-name">Monster</span>
                <div class="hp-bar-container"><div class="hp-bar" id="e-hp-bar"></div></div>
                <span class="monster-emoji" id="e-emoji">ğŸ‘¾</span>
            </div>
        </div>
        <div class="bench" id="player-bench"></div>
        <div id="log-box"></div>
        <button id="next-btn" onclick="nextTurn()" style="display:none;">æ¬¡ã¸</button>
    </div>
    
    <div id="start-screen">
        <p>èº«ã®å›ã‚Šã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦<br>æœ€å¼·ã®ãƒãƒ¼ãƒ ã‚’ä½œã‚ã†ï¼<br>(ãŠè“å­ã€æœ¬ã€æ–‡æˆ¿å…·ãªã©)</p>
        <button onclick="startScanning()">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <br><br>
        <button onclick="debugMode()" style="background:#888; font-size:0.8rem;">(ã‚«ãƒ¡ãƒ©ãªã—ã§ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤)</button>
    </div>
</div>

<script>
// === ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ ===
const EMOJIS = ['ğŸ²', 'ğŸ‘»', 'ğŸ§š', 'ğŸ¤–', 'ğŸ£', 'ğŸ±', 'ğŸ¦Š', 'ğŸ¦„', 'ğŸ¦‹', 'ğŸ¢', 'ğŸ™', 'ğŸŒµ', 'ğŸ„', 'ğŸŸ', 'ğŸ«', 'ğŸ¥¤'];
const PREFIXES = ['ãƒ—ãƒ‹', 'ãƒ¢ã‚³', 'ãƒ”ã‚³', 'ãƒ‰ãƒ©', 'ãƒ¡ã‚¬', 'ã‚¦ãƒ«', 'ãƒãƒ”', 'ãƒ€ãƒ¼ã‚¯', 'ãƒ¡ã‚«', 'ãƒ•ãƒ¯', 'ã‚¹ãƒ¼ãƒ‘ãƒ¼'];
const SUFFIXES = ['ãƒ¢ãƒ³', 'ã¡ã‚ƒã‚“', 'ã‚´ãƒ³', 'ãƒ”ãƒ¼', 'ã‚¿', 'ãƒ­', 'ãƒŠ', 'ãƒãƒ³', 'ã‚­ãƒ³ã‚°', 'ãƒãƒˆãƒ©ãƒ¼'];

let playerTeam = [];
let enemyTeam = [];
let pIndex = 0;
let eIndex = 0;
let scanCount = 0;

// === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0; 
    }
    return Math.abs(hash);
}

class Random {
    constructor(seed) { this.seed = seed; }
    next() {
        this.seed = (this.seed * 9301 + 49297) % 233280;
        return this.seed / 233280;
    }
    range(min, max) { return Math.floor(this.next() * (max - min + 1)) + min; }
    pick(arr) { return arr[Math.floor(this.next() * arr.length)]; }
}

// === ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç”Ÿæˆ ===
function generateMonster(barcodeData) {
    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®æ•°å­—ã‚’å…ƒã«ã‚·ãƒ¼ãƒ‰ç”Ÿæˆ
    const seed = hashString(String(barcodeData));
    const rng = new Random(seed);
    
    const type = rng.next() > 0.5 ? 'ç‰©ç†' : 'ç‰¹æ®Š';
    const emoji = rng.pick(EMOJIS);
    const name = rng.pick(PREFIXES) + rng.pick(SUFFIXES);
    
    const hp = rng.range(90, 160);
    let kp, kd, mp, md, sp;
    
    if (type === 'ç‰©ç†') {
        kp = rng.range(50, 90); mp = rng.range(10, 30);
        kd = rng.range(40, 70); md = rng.range(20, 50);
        skill = "ãŸã„ã‚ãŸã‚Š";
    } else {
        kp = rng.range(10, 30); mp = rng.range(50, 90);
        kd = rng.range(20, 50); md = rng.range(40, 70);
        skill = "ãƒ“ãƒ¼ãƒ ";
    }
    sp = rng.range(40, 100);

    const physSkills = ["ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ–¬ã‚Š", "ã‚¹ã‚­ãƒ£ãƒ³ã‚¢ã‚¿ãƒƒã‚¯", "ç®±ã‚«ãƒ‰æ”»æ’ƒ", "ä½“å½“ãŸã‚Š"];
    const specSkills = ["ãƒ¬ãƒ¼ã‚¶ãƒ¼ãƒ“ãƒ¼ãƒ ", "ãƒ‡ãƒ¼ã‚¿ãƒ‰ãƒ¬ã‚¤ãƒ³", "é›»å­ãƒ‘ãƒ«ã‚¹", "å¿µåŠ›"];
    const skillName = type === 'ç‰©ç†' ? rng.pick(physSkills) : rng.pick(specSkills);

    return {
        name, emoji, hp, maxHp: hp,
        kp, kd, mp, md, sp,
        type, skillName,
        id: barcodeData
    };
}

// === ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† (QuaggaJS) ===
function startScanning() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('scan-ui').style.display = 'block';

    Quagga.init({
        inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.querySelector('#camera-area'),
            constraints: {
                facingMode: "environment", // èƒŒé¢ã‚«ãƒ¡ãƒ©
                width: 640,
                height: 480
            }
        },
        decoder : {
            // æ—¥æœ¬ã®ä¸€èˆ¬çš„ãªãƒãƒ¼ã‚³ãƒ¼ãƒ‰(JAN/EAN)ã«å¯¾å¿œ
            readers : ["ean_reader", "ean_8_reader"]
        }
    }, function(err) {
        if (err) {
            console.log(err);
            alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nhttpsæ¥ç¶šã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        Quagga.start();
    });

    Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        
        // èª¤æ¤œçŸ¥ã‚’é˜²ããŸã‚ã€ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ï¼ˆæ•°å€¤ã®ã¿ã‹ï¼‰
        if(!code || !code.match(/^[0-9]+$/)) return;

        // é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢
        const alreadyScanned = playerTeam.some(m => m.id === code);
        if (!alreadyScanned) {
            // èª­ã¿å–ã‚ŠæˆåŠŸæ™‚ã€ä¸€æ™‚åœæ­¢ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆ
            Quagga.stop(); 
            addMonsterToTeam(code);
        }
    });
}

function addMonsterToTeam(data) {
    const monster = generateMonster(data);
    playerTeam.push(monster);
    scanCount++;
    document.getElementById('scan-count').innerText = scanCount;
    
    alert(`èª­ã¿å–ã‚ŠæˆåŠŸï¼\nã‚³ãƒ¼ãƒ‰: ${data}\n\nã€Œ${monster.name}ã€ãŒç¾ã‚ŒãŸï¼\n(HP: ${monster.hp} / æ”»æ’ƒ: ${monster.type})`);

    if (scanCount >= 3) {
        initBattle();
    } else {
        // ã¾ã 3ä½“ã„ãªã‘ã‚Œã°ã‚«ãƒ¡ãƒ©å†é–‹
        Quagga.start();
    }
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰
function debugMode() {
    addMonsterToTeam("4901234567890"); // ãƒ©ãƒ³ãƒ€ãƒ ãªJANã‚³ãƒ¼ãƒ‰é¢¨
    addMonsterToTeam("4501234567891");
    addMonsterToTeam("4909999999999");
}

// === ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ (å‰å›ã¨åŒã˜) ===
function initBattle() {
    document.getElementById('scan-ui').style.display = 'none';
    document.getElementById('battle-ui').style.display = 'block';
    
    for(let i=0; i<3; i++) {
        enemyTeam.push(generateMonster("enemy" + i + Math.random()));
    }
    
    updateBenchUI();
    updateBattleUI();
    log("ãƒãƒˆãƒ«é–‹å§‹ï¼");
    log(`ç›¸æ‰‹ã¯ ${enemyTeam[0].name} ãªã©ã‚’ç¹°ã‚Šå‡ºã—ã¦ããŸï¼`);
    document.getElementById('next-btn').style.display = 'inline-block';
}

function updateBenchUI() {
    const pBench = document.getElementById('player-bench');
    const eBench = document.getElementById('enemy-bench');
    pBench.innerHTML = ""; eBench.innerHTML = "";
    
    playerTeam.forEach((m, i) => {
        pBench.innerHTML += `<div class="bench-icon ${m.hp > 0 ? 'alive' : 'dead'}">${m.emoji}</div>`;
    });
    enemyTeam.forEach((m, i) => {
        eBench.innerHTML += `<div class="bench-icon ${m.hp > 0 ? 'alive' : 'dead'}">${m.emoji}</div>`;
    });
}

function updateBattleUI() {
    const pm = playerTeam[pIndex];
    const em = enemyTeam[eIndex];
    
    document.getElementById('p-name').innerText = pm.name;
    document.getElementById('p-emoji').innerText = pm.emoji;
    document.getElementById('p-hp-bar').style.width = (pm.hp / pm.maxHp * 100) + "%";
    
    document.getElementById('e-name').innerText = em.name;
    document.getElementById('e-emoji').innerText = em.emoji;
    document.getElementById('e-hp-bar').style.width = (em.hp / em.maxHp * 100) + "%";
}

function log(msg) {
    const box = document.getElementById('log-box');
    box.innerHTML += `<div class="log-line">${msg}</div>`;
    box.scrollTop = box.scrollHeight;
}

function calcDamage(attacker, defender) {
    let damage = 0;
    if (attacker.type === 'ç‰©ç†') {
        let base = (attacker.kp * 0.8) - (defender.kd * 0.2);
        damage = Math.floor(base + (Math.random() * 10));
    } else {
        let base = (attacker.mp * 0.8) - (defender.md * 0.2);
        damage = Math.floor(base + (Math.random() * 10));
    }
    return Math.max(1, damage);
}

function nextTurn() {
    const pm = playerTeam[pIndex];
    const em = enemyTeam[eIndex];
    
    if (pIndex >= 3 || eIndex >= 3) return;

    if (pm.hp <= 0) {
        pIndex++;
        if (pIndex >= 3) { log("<b>ã‚ãªãŸã®è² ã‘...</b>"); document.getElementById('next-btn').disabled = true; return; }
        log(`ã‚†ã‘ã£ï¼ ${playerTeam[pIndex].name}ï¼`);
        updateBattleUI();
        updateBenchUI();
        return;
    }
    if (em.hp <= 0) {
        eIndex++;
        if (eIndex >= 3) { log("<b>ã‚ãªãŸã®å‹ã¡ï¼</b>"); document.getElementById('next-btn').disabled = true; return; }
        log(`ç›¸æ‰‹ã¯ ${enemyTeam[eIndex].name} ã‚’ç¹°ã‚Šå‡ºã—ãŸï¼`);
        updateBattleUI();
        updateBenchUI();
        return;
    }

    let first = pm.sp >= em.sp ? pm : em;
    let second = pm.sp >= em.sp ? em : pm;
    let isPlayerFirst = pm === first;

    attack(first, second, isPlayerFirst);
    
    if (second.hp > 0) {
        setTimeout(() => {
            attack(second, first, !isPlayerFirst);
        }, 1000);
    }
}

function attack(atk, def, isPlayerAtk) {
    const atkEl = isPlayerAtk ? document.getElementById('p-card') : document.getElementById('e-card');
    const defEl = isPlayerAtk ? document.getElementById('e-card') : document.getElementById('p-card');
    
    atkEl.classList.add('attack-anim');
    setTimeout(() => atkEl.classList.remove('attack-anim'), 300);

    const damage = calcDamage(atk, def);
    def.hp = Math.max(0, def.hp - damage);
    
    log(`${atk.name}ã®${atk.skillName}ï¼ ${def.name}ã«${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    
    if (def.hp > 0) {
        defEl.classList.add('damage-anim');
        setTimeout(() => defEl.classList.remove('damage-anim'), 500);
    } else {
        log(`${def.name}ã¯å€’ã‚ŒãŸï¼`);
    }
    
    updateBattleUI();
    updateBenchUI();
}
</script>
</body>
</html>