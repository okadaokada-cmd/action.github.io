<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Monster Battle</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        :root {
            --p-color: #FF9AA2; /* Player Color */
            --e-color: #85E3FF; /* Enemy Color */
            --bg-color: #FFF5F5;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: #444;
            text-align: center;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        h1 { margin: 10px 0; font-size: 1.2rem; color: #FF6F61; }
        
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #game-container { max-width: 600px; margin: 0 auto; padding: 10px; }
        
        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        #scan-ui { display: none; }
        #canvas-container { position: relative; margin: 10px auto; width: 300px; height: 300px; background: #000; border-radius: 10px; overflow: hidden; }
        canvas { width: 100%; height: 100%; }
        #scan-instruction { margin-bottom: 10px; font-weight: bold; }

        /* ãƒãƒˆãƒ«ã‚¨ãƒªã‚¢ */
        #battle-ui { display: none; }
        .battle-field { display: flex; justify-content: space-between; align-items: flex-end; padding: 20px; height: 200px; background: #fff; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 10px; position: relative; }
        
        .monster-card { width: 45%; text-align: center; transition: all 0.3s; }
        .monster-emoji { font-size: 4rem; display: block; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }
        .monster-name { font-weight: bold; font-size: 0.9rem; margin-top: 5px; display: block; }
        .hp-bar-container { width: 100%; height: 10px; background: #ddd; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .hp-bar { height: 100%; width: 100%; transition: width 0.5s; }
        
        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å´ */
        .player .hp-bar { background: var(--p-color); }
        .player .monster-emoji { transform: scaleX(-1); } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å³å‘ã */

        /* æ•µå´ */
        .enemy .hp-bar { background: var(--e-color); }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .stats-box { font-size: 0.8rem; background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; margin-top: 5px; display: none; }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ­ã‚° */
        #log-box { 
            height: 150px; overflow-y: scroll; 
            background: #fff; border: 2px solid #eee; 
            border-radius: 10px; padding: 10px; text-align: left; font-size: 0.9rem; 
            margin-bottom: 10px;
        }
        .log-line { margin-bottom: 4px; border-bottom: 1px dashed #eee; padding-bottom: 2px; }
        
        /* æ§ãˆãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ */
        .bench { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .bench-icon { font-size: 1.5rem; opacity: 0.5; }
        .bench-icon.alive { opacity: 1; }
        .bench-icon.dead { opacity: 0.2; filter: grayscale(100%); }

        button {
            background: #FF6F61; color: white; border: none; padding: 10px 20px;
            font-size: 1rem; border-radius: 20px; cursor: pointer; margin-top: 10px;
        }
        button:disabled { background: #ccc; }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .damage-anim { animation: shake 0.5s; }
        .attack-anim { animation: lunge 0.3s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        @keyframes lunge { 0% { transform: translateX(0); } 50% { transform: translateX(20px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

<div id="game-container">
    <h1>QR Monster Battle</h1>

    <div id="scan-ui">
        <div id="scan-instruction">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­... (<span id="scan-count">0</span>/3)</div>
        <div id="canvas-container">
            <canvas id="qr-canvas"></canvas>
        </div>
        <p style="font-size:0.8rem; color:#888;">ã‚«ãƒ¡ãƒ©ã«QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„ã€‚<br>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚‚èª­ã¿å–ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>

    <div id="battle-ui">
        <div class="bench" id="enemy-bench"></div>
        
        <div class="battle-field">
            <div class="monster-card player" id="p-card">
                <span class="monster-name" id="p-name">Monster</span>
                <div class="hp-bar-container"><div class="hp-bar" id="p-hp-bar"></div></div>
                <span class="monster-emoji" id="p-emoji">ğŸ£</span>
                <div class="stats-box" id="p-stats"></div>
            </div>
            <div class="monster-card enemy" id="e-card">
                <span class="monster-name" id="e-name">Monster</span>
                <div class="hp-bar-container"><div class="hp-bar" id="e-hp-bar"></div></div>
                <span class="monster-emoji" id="e-emoji">ğŸ‘¾</span>
                <div class="stats-box" id="e-stats"></div>
            </div>
        </div>

        <div class="bench" id="player-bench"></div>

        <div id="log-box"></div>

        <button id="next-btn" onclick="nextTurn()" style="display:none;">æ¬¡ã¸</button>
    </div>
    
    <div id="start-screen">
        <p>QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¯æ„›ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’å¬å–šã—ã¦<br>3vs3ã®ãƒãƒˆãƒ«ã‚’ã—ã‚ˆã†ï¼</p>
        <button onclick="startScanning()">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <br><br>
        <button onclick="debugMode()" style="background:#888; font-size:0.8rem;">(ã‚«ãƒ¡ãƒ©ãªã—ã§ãƒ†ã‚¹ãƒˆãƒ—ãƒ¬ã‚¤)</button>
    </div>
</div>

<script>
// === ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®š ===
const EMOJIS = ['ğŸ²', 'ğŸ‘»', 'ğŸ§š', 'ğŸ¤–', 'ğŸ£', 'ğŸ±', 'ğŸ¦Š', 'ğŸ¦„', 'ğŸ¦‹', 'ğŸ¢', 'ğŸ™', 'ğŸŒµ', 'ğŸ„'];
const PREFIXES = ['ãƒ—ãƒ‹', 'ãƒ¢ã‚³', 'ãƒ”ã‚³', 'ãƒ‰ãƒ©', 'ãƒ¡ã‚¬', 'ã‚¦ãƒ«', 'ãƒãƒ”', 'ãƒ€ãƒ¼ã‚¯', 'ãƒ¡ã‚«', 'ãƒ•ãƒ¯'];
const SUFFIXES = ['ãƒ¢ãƒ³', 'ã¡ã‚ƒã‚“', 'ã‚´ãƒ³', 'ãƒ”ãƒ¼', 'ã‚¿', 'ãƒ­', 'ãƒŠ', 'ãƒãƒ³', 'ã‚­ãƒ³ã‚°'];

let playerTeam = [];
let enemyTeam = [];
let pIndex = 0;
let eIndex = 0;
let scanCount = 0;
let isScanning = false;
let video = document.createElement("video");
let canvasElement = document.getElementById("qr-canvas");
let canvas = canvasElement.getContext("2d");

// === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚’ç”Ÿæˆ ===
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0; 
    }
    return Math.abs(hash);
}

// ä¹±æ•°ç”Ÿæˆå™¨ (ã‚·ãƒ¼ãƒ‰ä»˜ã)
class Random {
    constructor(seed) { this.seed = seed; }
    next() {
        this.seed = (this.seed * 9301 + 49297) % 233280;
        return this.seed / 233280;
    }
    range(min, max) { return Math.floor(this.next() * (max - min + 1)) + min; }
    pick(arr) { return arr[Math.floor(this.next() * arr.length)]; }
}

// === ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç”Ÿæˆ ===
function generateMonster(qrData) {
    const seed = hashString(qrData);
    const rng = new Random(seed);
    
    const type = rng.next() > 0.5 ? 'ç‰©ç†' : 'ç‰¹æ®Š';
    const emoji = rng.pick(EMOJIS);
    const name = rng.pick(PREFIXES) + rng.pick(SUFFIXES);
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”Ÿæˆ (åˆè¨ˆå€¤ã‚’ã‚ã‚‹ç¨‹åº¦ä¸€å®šã«ã™ã‚‹ãŒå€‹æ€§ã‚’å‡ºã™)
    const hp = rng.range(80, 150);
    let kp, kd, mp, md, sp;
    
    if (type === 'ç‰©ç†') {
        kp = rng.range(40, 80); mp = rng.range(10, 30);
        kd = rng.range(30, 60); md = rng.range(20, 50);
        skill = "ãŸã„ã‚ãŸã‚Š";
    } else {
        kp = rng.range(10, 30); mp = rng.range(40, 80);
        kd = rng.range(20, 50); md = rng.range(30, 60);
        skill = "ãƒ“ãƒ¼ãƒ ";
    }
    sp = rng.range(30, 90);

    // æŠ€åãƒ©ãƒ³ãƒ€ãƒ åŒ–
    const physSkills = ["ãƒ‘ãƒ³ãƒ", "ã‚­ãƒƒã‚¯", "é ­çªã", "ã‚¹ãƒ©ãƒƒã‚·ãƒ¥"];
    const specSkills = ["ãƒ•ã‚¡ã‚¤ã‚¢", "ã‚µãƒ³ãƒ€ãƒ¼", "ãƒ“ãƒ¼ãƒ ", "å¿µåŠ›"];
    const skillName = type === 'ç‰©ç†' ? rng.pick(physSkills) : rng.pick(specSkills);

    return {
        name, emoji, hp, maxHp: hp,
        kp, kd, mp, md, sp,
        type, skillName,
        id: qrData // ãƒ‡ãƒãƒƒã‚°ç”¨
    };
}

// === ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ===
function startScanning() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('scan-ui').style.display = 'block';
    isScanning = true;
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(function(stream) {
        video.srcObject = stream;
        video.setAttribute("playsinline", true); 
        video.play();
        requestAnimationFrame(tick);
    });
}

function tick() {
    if (!isScanning) return;
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        
        var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        var code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
        
        if (code) {
            // é‡è¤‡ã‚¹ã‚­ãƒ£ãƒ³é˜²æ­¢
            const alreadyScanned = playerTeam.some(m => m.id === code.data);
            if (!alreadyScanned) {
                addMonsterToTeam(code.data);
            }
        }
    }
    requestAnimationFrame(tick);
}

function addMonsterToTeam(data) {
    // èª­ã¿å–ã‚ŠæˆåŠŸæ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆéŸ³ã®ä»£ã‚ã‚Šã«è‰²åè»¢ãªã©ã—ãŸã„ãŒçœç•¥ï¼‰
    const monster = generateMonster(data);
    playerTeam.push(monster);
    scanCount++;
    document.getElementById('scan-count').innerText = scanCount;
    
    alert(`ã€Œ${monster.name}ã€ã‚’èª­ã¿è¾¼ã‚“ã ï¼\nã‚¿ã‚¤ãƒ—: ${monster.type}\nHP: ${monster.hp}`);

    if (scanCount >= 3) {
        isScanning = false;
        video.srcObject.getTracks().forEach(track => track.stop()); // ã‚«ãƒ¡ãƒ©åœæ­¢
        initBattle();
    }
}

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ¡ãƒ©ãªã—ã§ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼‰
function debugMode() {
    addMonsterToTeam("debug1" + Math.random());
    addMonsterToTeam("debug2" + Math.random());
    addMonsterToTeam("debug3" + Math.random());
}

// === ãƒãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ ===
function initBattle() {
    document.getElementById('scan-ui').style.display = 'none';
    document.getElementById('battle-ui').style.display = 'block';
    
    // æ•µãƒãƒ¼ãƒ ã®ç”Ÿæˆï¼ˆè‡ªå‹•ï¼‰
    for(let i=0; i<3; i++) {
        enemyTeam.push(generateMonster("enemy" + i + Math.random())); // ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰
    }
    
    updateBenchUI();
    updateBattleUI();
    log("ãƒãƒˆãƒ«é–‹å§‹ï¼");
    log(`ç›¸æ‰‹ã¯ ${enemyTeam[0].name} ãªã©ã‚’ç¹°ã‚Šå‡ºã—ã¦ããŸï¼`);
    
    document.getElementById('next-btn').style.display = 'inline-block';
}

function updateBenchUI() {
    const pBench = document.getElementById('player-bench');
    const eBench = document.getElementById('enemy-bench');
    pBench.innerHTML = ""; eBench.innerHTML = "";
    
    playerTeam.forEach((m, i) => {
        pBench.innerHTML += `<div class="bench-icon ${m.hp > 0 ? 'alive' : 'dead'}">${m.emoji}</div>`;
    });
    enemyTeam.forEach((m, i) => {
        eBench.innerHTML += `<div class="bench-icon ${m.hp > 0 ? 'alive' : 'dead'}">${m.emoji}</div>`;
    });
}

function updateBattleUI() {
    const pm = playerTeam[pIndex];
    const em = enemyTeam[eIndex];
    
    // Player UI
    document.getElementById('p-name').innerText = pm.name;
    document.getElementById('p-emoji').innerText = pm.emoji;
    document.getElementById('p-hp-bar').style.width = (pm.hp / pm.maxHp * 100) + "%";
    
    // Enemy UI
    document.getElementById('e-name').innerText = em.name;
    document.getElementById('e-emoji').innerText = em.emoji;
    document.getElementById('e-hp-bar').style.width = (em.hp / em.maxHp * 100) + "%";
}

function log(msg) {
    const box = document.getElementById('log-box');
    box.innerHTML += `<div class="log-line">${msg}</div>`;
    box.scrollTop = box.scrollHeight;
}

function calcDamage(attacker, defender) {
    let damage = 0;
    // æ”»æ’ƒç¨®é¡ã¨æ•°å€¤ã«åˆã‚ã›ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸
    // å¼: (æ”»æ’ƒ / 2) - (é˜²å¾¡ / 4) + ä¹±æ•°ã€‚æœ€ä½1ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚
    if (attacker.type === 'ç‰©ç†') {
        let base = (attacker.kp * 0.8) - (defender.kd * 0.2);
        damage = Math.floor(base + (Math.random() * 10));
    } else {
        let base = (attacker.mp * 0.8) - (defender.md * 0.2);
        damage = Math.floor(base + (Math.random() * 10));
    }
    return Math.max(1, damage);
}

function nextTurn() {
    const pm = playerTeam[pIndex];
    const em = enemyTeam[eIndex];
    
    // å‹æ•—åˆ¤å®šæ¸ˆã¿ãªã‚‰ãƒªã‚¿ãƒ¼ãƒ³
    if (pIndex >= 3 || eIndex >= 3) return;

    // ã©ã¡ã‚‰ã‹ãŒå€’ã‚Œã¦ã„ã‚‹å ´åˆã®äº¤ä»£å‡¦ç†
    if (pm.hp <= 0) {
        pIndex++;
        if (pIndex >= 3) { log("<b>ã‚ãªãŸã®è² ã‘...</b>"); document.getElementById('next-btn').disabled = true; return; }
        log(`ã‚†ã‘ã£ï¼ ${playerTeam[pIndex].name}ï¼`);
        updateBattleUI();
        updateBenchUI();
        return;
    }
    if (em.hp <= 0) {
        eIndex++;
        if (eIndex >= 3) { log("<b>ã‚ãªãŸã®å‹ã¡ï¼</b>"); document.getElementById('next-btn').disabled = true; return; }
        log(`ç›¸æ‰‹ã¯ ${enemyTeam[eIndex].name} ã‚’ç¹°ã‚Šå‡ºã—ãŸï¼`);
        updateBattleUI();
        updateBenchUI();
        return;
    }

    // ç´ æ—©ã•åˆ¤å®šã§è¡Œå‹•é †æ±ºå®š
    let first = pm.sp >= em.sp ? pm : em;
    let second = pm.sp >= em.sp ? em : pm;
    let isPlayerFirst = pm === first;

    // å…ˆæ”»ã®æ”»æ’ƒ
    attack(first, second, isPlayerFirst);
    
    // å¾Œæ”»ãŒç”Ÿãã¦ã„ã‚Œã°æ”»æ’ƒ
    if (second.hp > 0) {
        setTimeout(() => {
            attack(second, first, !isPlayerFirst);
        }, 1000); // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åæ’ƒ
    }
}

function attack(atk, def, isPlayerAtk) {
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ä»˜ä¸
    const atkEl = isPlayerAtk ? document.getElementById('p-card') : document.getElementById('e-card');
    const defEl = isPlayerAtk ? document.getElementById('e-card') : document.getElementById('p-card');
    
    atkEl.classList.add('attack-anim');
    setTimeout(() => atkEl.classList.remove('attack-anim'), 300);

    const damage = calcDamage(atk, def);
    def.hp = Math.max(0, def.hp - damage);
    
    log(`${atk.name}ã®${atk.skillName}ï¼ ${def.name}ã«${damage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`);
    
    if (def.hp > 0) {
        defEl.classList.add('damage-anim');
        setTimeout(() => defEl.classList.remove('damage-anim'), 500);
    } else {
        log(`${def.name}ã¯å€’ã‚ŒãŸï¼`);
    }
    
    updateBattleUI();
    updateBenchUI();
}
</script>
</body>
</html>